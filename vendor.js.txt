const API = 'http://localhost:5000';
const socket = io(API);

let vendorState = { id: null, products: [] };

const $ = id => document.getElementById(id);
const showToast = (msg, ms=2200) => {
  alert(msg);
};

// Load dashboard for vendor
$('loadBtn').addEventListener('click', async () => {
  const vid = parseInt($('vendorId').value);
  if(!vid){ alert('Enter vendor id'); return; }
  vendorState.id = vid;
  $('dashboard').style.display='block';

  // join vendor room to receive order notifications
  socket.emit('join_vendor_room', { vendor_id: vid });

  await loadProducts();
});

async function loadProducts(){
  try {
    const res = await fetch(`${API}/vendors/${vendorState.id}/products`);
    const data = await res.json();
    vendorState.products = data.products;
    renderProducts();
  } catch (err) {
    console.error(err); alert('Could not load products');
  }
}

function renderProducts(){
  const container = $('productList'); container.innerHTML='';
  vendorState.products.forEach(p=>{
    const el = document.createElement('div'); el.className='product card';
    el.innerHTML = `<img src="${p.img||'https://via.placeholder.com/80'}" alt="${p.name}">
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between"><div>${p.name}</div><div style="font-weight:700">â‚¹${p.price}</div></div>
        <div class="small">Stock: <span id="stock-${p.id}">${p.stock}</span></div>
      </div>
      <div>
        <input id="stockInput-${p.id}" class="input" style="width:72px" type="number" placeholder="stock" />
        <button data-id="${p.id}" class="input updateBtn">Update</button>
      </div>`;
    container.appendChild(el);
  });
  container.querySelectorAll('.updateBtn').forEach(b=>b.addEventListener('click', async (e)=>{
    const id = +e.currentTarget.dataset.id;
    const val = document.getElementById('stockInput-'+id).value;
    await updateStock(id, parseInt(val,10));
  }));
}

async function updateStock(productId, stockVal){
  if(isNaN(stockVal)){ alert('Enter numeric stock'); return; }
  try {
    const res = await fetch(`${API}/products/${productId}`, {
      method: 'PUT',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ stock: stockVal })
    });
    const data = await res.json();
    if(data.ok){
      document.getElementById('stock-'+productId).textContent = stockVal;
      showToast('Stock updated');
    }
  } catch (err) {
    console.error(err); alert('Failed to update');
  }
}

$('addProductBtn').addEventListener('click', async ()=>{
  const name = $('pName').value.trim();
  const price = parseFloat($('pPrice').value);
  const stock = parseInt($('pStock').value,10) || 0;
  const img = $('pImg').value.trim();
  if(!name || isNaN(price)) { alert('Provide name and price'); return; }
  try {
    // Simple: create product directly via sqlite (no API route for create in basic demo)
    // We'll call vendor_products to reload; in real app add POST /vendors/:id/products
    alert('This demo does not implement create via API. Use DB init or extend backend to add product creation.');
  } catch (err) {
    console.error(err);
  }
});

// Listen for new orders targeted to this vendor's room
socket.on('new_order', data=>{
  if(data.vendor_id === vendorState.id){
    // append order to list
    const ol = $('ordersList');
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div>Order #: ${data.order_id}</div><pre style="white-space:pre-wrap">${JSON.stringify(data.data, null, 2)}</pre>`;
    ol.prepend(div);
    alert('New order received');
  }
});

// Also listen to product_update messages so vendor can see updates
socket.on('product_update', data=>{
  console.log('product update', data);
});
